<!DOCTYPE html>
<html>
<head><title>Timer</title>
  <style>
    body {
      background-color: black;
      color: white;
      font: 10vh/11vh "Segoe UI", sans-serif;
      margin: 5vh auto;
      height: 90vh;
      width: 60vw;
    }

    .milli {
      color: wheat;
      font-size: 60%;
    }

    #timer {
      font-size: larger;
      line-height: normal;
    }

    #total_timer {
      color: grey;
    }
  </style>
</head>
<body>
<div id="timer"><span>0:00</span><span class="milli">.00</span></div>
<div id="loops"></div>
<div id="total_timer"><span>0:00</span></div>
<script>
  "use strict";
  document.body.addEventListener("mousedown", onTouch, false);
  document.body.addEventListener("touchstart", onTouch, false);
  addEventListener("popstate", popState);
  Number.prototype.getMilliseconds = function (digits) {
    return '.' + ('00' + this).substr(-3, digits);
  };
  Number.prototype.toHHMMSS = function () {
    const sec_num = Math.floor(this / 1000);
    let hours = Math.floor(sec_num / 3600);
    let minutes = Math.floor((sec_num - (hours * 3600)) / 60);
    let seconds = sec_num - (hours * 3600) - (minutes * 60);

    if (minutes < 10 && hours) minutes = "0" + minutes;
    if (seconds < 10) seconds = "0" + seconds;
    hours = hours ? hours + ':' : '';
    return hours + minutes + ':' + seconds;
  };

  let timer = document.getElementById('timer');
  let total_timer = document.getElementById('total_timer');
  let loops = document.getElementById('loops');

  setInterval(() => {
    update(timer, 1)
  }, 100);

  history.replaceState(document.body.innerHTML, '');	//	save initial state

  function popState(e) {
    document.body.innerHTML = e.state;
    timer = document.getElementById('timer');
    update(timer, 1); //  remove update lag
    total_timer = document.getElementById('total_timer');
    loops = document.getElementById('loops');
  }

  function onTouch(e) {
    e.preventDefault();

    if (timer.dataset.timerBegin) {
      addLoop();
    } else {
      total_timer.dataset.timerBegin = +new Date();
    }

    timer.dataset.timerBegin = +new Date();
    history.pushState(document.body.innerHTML, "");
  }

  function addLoop() {
    const newDiv = document.createElement('span');
    newDiv.innerHTML = timer.innerHTML + "<br>";
    newDiv.dataset.timerBegin = timer.dataset.timerBegin;
    update(newDiv, 2);
    update(total_timer, 0);

    if (loops.firstChild) {
      loops.insertBefore(newDiv, loops.firstChild);
    } else {
      loops.appendChild(newDiv);
    }

    if (loops.children[5]) {
      loops.removeChild(loops.children[5]);
    }
  }

  function update(node, digits) {
    if (!node.dataset.timerBegin) {
      return;
    }
    const sec_num = new Date() - node.dataset.timerBegin;
    node.firstChild.innerHTML = sec_num.toHHMMSS();
    if (digits) {
      node.children[1].innerHTML = sec_num.getMilliseconds(digits)
    }
  }
</script>
</body>
</html>
