<!DOCTYPE html>
<html>
<head><title>Timer</title>
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <style>
    html {
      background-color: #161616;
    }

    body {
      background-color: black;
      color: white;
      font: 10vh/11vh "Segoe UI", sans-serif;
      margin: 5vh auto;
      height: 90vh;
      width: 60vw;
      padding: 0 5%;
    }

    .milli {
      color: wheat;
      font-size: 60%;
    }

    #timer {
      font-size: larger;
      line-height: normal;
    }

    #total_sum, #total_sum .milli {
      color: grey;
    }
  </style>
</head>
<body>
<div id="timer"><span>0:00</span><span class="milli">.0</span></div>
<div id="loops"></div>
<div id="total_sum"><span>0:00</span><span class="milli">.00</span></div>
<div id="total_timer"><span>0:00</span><span class="milli">.0</span></div>
<script>
  "use strict";

  const maxLoops = 4;
  document.body.addEventListener("mousedown", onTouch, {passive: false});
  document.body.addEventListener("touchstart", onTouch, {passive: false});
  addEventListener("popstate", popState);

  Number.prototype.getMilliseconds = function (digits) {
    return '.' + ('00' + this).substr(-3, digits);
  };

  Number.prototype.toHHMMSS = function () {
    const sec_num = Math.floor(this / 1000);
    let hours = Math.floor(sec_num / 3600);
    let minutes = Math.floor((sec_num - (hours * 3600)) / 60);
    let seconds = sec_num - (hours * 3600) - (minutes * 60);

    if (minutes < 10 && hours) minutes = "0" + minutes;
    if (seconds < 10) seconds = "0" + seconds;
    hours = hours ? hours + ':' : '';
    return hours + minutes + ':' + seconds;
  };

  const $timer = document.getElementById('timer');
  const $totalSum = document.getElementById('total_sum');
  const $totalTimer = document.getElementById('total_timer');
  const $loops = document.getElementById('loops');

  function animation() {
    update($timer, 1);
    update($totalTimer, 1);
    requestAnimationFrame(animation);
  }

  animation();

  history.replaceState(document.body.innerHTML, '');	//	save initial state

  function popState(e) {
    document.body.innerHTML = e.state;
    update($timer, 1); //  remove update lag
  }

  function onTouch(e) {
    e.preventDefault();

    if ($timer.dataset.timerBegin) {
      addLoop();
    } else {
      $totalSum.dataset.timerBegin = (+new Date()).toString();
      $totalTimer.dataset.timerBegin = (+new Date()).toString();
    }

    $timer.dataset.timerBegin = (+new Date()).toString();
    history.pushState(document.body.innerHTML, "");
  }

  function addLoop() {
    const $newDiv = document.createElement('span');
    $newDiv.innerHTML = $timer.innerHTML + "<br>";
    $newDiv.dataset.timerBegin = $timer.dataset.timerBegin;
    update($newDiv, 2);
    update($totalSum, 2);

    $loops.prepend($newDiv);

    if ($loops.children[maxLoops]) {
      $loops.removeChild($loops.children[maxLoops]);
    }
  }

  function update($node, digits) {
    if (!$node.dataset.timerBegin) {
      return;
    }
    const sec_num = new Date() - $node.dataset.timerBegin;
    $node.firstChild.innerHTML = sec_num.toHHMMSS();
    if (digits) {
      $node.children[1].innerHTML = sec_num.getMilliseconds(digits)
    }
  }
</script>
</body>
</html>
